{{- $codetype := .Get "lang" -}}
{{- $prefix := (.Get "prefix") | default "" -}}
{{- $postfix := (.Get "postfix") | default "" -}}
{{- $branch := delimit (slice "?ref=" (.Get "branch" | default "master")) "" | string -}}
{{- $clear := (.Get "clear") -}}
{{- $id := (.Get "id") -}}
{{- $linenumbers := (.Get "linenumbers") | default "" -}}

{{- $file := getJSON "https://api.github.com/repos/" (.Get "user") "/" (.Get "repo") "/contents/" (.Get "file") $branch -}}


{{- if .Get "filter" -}}

    {{- $result := findRE (.Get "filter") ($file.content | base64Decode) (.Get "result" | default 1 | int) -}}
    {{- range $result -}}
        <pre class="language-{{- $codetype }} {{ if gt (len $linenumbers) 0 -}}line-numbers{{- end -}}" {{ if $id }}id="source-{{- $id -}}"{{ end }} {{ if eq $codetype "agentspeak" -}}data-language="AgentSpeak(L++)"{{- end }}><code class="language-{{- $codetype -}}">
{{- $prefix }}
{{ if $clear }}{{ . }}{{ else }}{{ . }}{{ end }}
{{ $postfix -}}
        </code></pre>
    {{- end -}}

{{- else -}}

    <pre class="language-{{- $codetype }} {{ if gt (len $linenumbers) 0 -}}line-numbers{{- end -}}" {{ if $id }}id="source-{{- $id -}}"{{ end }} {{ if eq $codetype "agentspeak" -}}data-language="AgentSpeak(L++)"{{- end }}><code class="language-{{- $codetype -}}">
{{- $prefix }}
{{ $file.content | base64Decode }}
{{ $postfix -}}
    </code></pre>

{{- end -}}

